!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("react"));else if("function"==typeof define&&define.amd)define(["react"],e);else{var i="object"==typeof exports?e(require("react")):e(t.react);for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}(window,function(i){return s={},a.m=n=[function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}t.exports=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}},function(t,e){t.exports=i},function(t,e,i){var n=i(4),a=i(5),s=i(6);t.exports=function(t){return n(t)||a(t)||s()}},function(t,e){t.exports=function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}},function(t,e){t.exports=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(t,e,i){"use strict";i.r(e);function s(e,i){var n=[];return e.forEach?e.forEach(function(t){i(t)&&n.push(t)}):Object.keys(e).forEach(function(t){i(e[t])&&n.push(e[t])}),n}function o(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};a()(this,o),this.components=t,this.entities=e,this.array=[]}var n=i(0),a=i.n(n),r=i(1),h=i.n(r),u=i(3),l=i.n(u);o.groups={},o.reset=function(){o.groups={}},o.generateGroupKey=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];e.push(n)}return e.map(function(t){return t.toLowerCase()}).sort().join("-")},o.getGroup=function(t){var e=o.generateGroupKey(t);return o.groups[e]||{}},o.indexGroup=function(t,e){var i,n=t.reduce?t:[t],a=o.generateGroupKey(n);if(!o.groups[a])return i=o.groups[a]=new o(n),s(e,function(t){t.hasComponents(n)&&(i.entities[t.id]=t,i.array=[].concat(l()(i.array),[t]))}),i};function c(t,e){var i=1<arguments.length&&void 0!==e?e:0,n=t.length;if(n&&!(n<=i)){for(;i<n;)t[i]=t[i+1],i++;t.length--}}var d=o,p=function(){function o(t){a()(this,o),o.counter++,this.id=o.counter,this.constructor=t,this.components={},o.entities[this.id]=this}return h()(o,[{key:"assignGroup",value:function(t){t.entities[this.id]=this}},{key:"addComponent",value:function(t){this.components[t.name]=t,this[t.name]=t;var e=[];for(var i in this.components)e.push(i);for(var n in d.indexGroup(e,o.entities),d.groups){var a=d.groups[n];if(!a.entities[this.id]&&(-1!==a.components.indexOf(t.name)&&this.hasComponents(a.components))){this.assignGroup(a);var s=this.copyArray(a);a.array=this.extendGroup(s)}}}},{key:"copyArray",value:function(t){return t.array}},{key:"extendGroup",value:function(t){return t[t.length]=this,t}},{key:"removeComponent",value:function(t){var e=this.components[t]||t,i=e.name;for(var n in d.groups){var a=d.groups[n],s=-1<a.components.indexOf(e.name),o=this.hasComponents(a.components);a.entities[this.id]&&s&&o&&(delete a.entities[this.id],c(a.array,a.array.indexOf(this)))}delete this.components[i],delete this[i]}},{key:"destroy",value:function(){var e=this;Object.keys(this.components).forEach(function(t){e.removeComponent(e.components[t])}),delete o.entities[this.id]}},{key:"hasComponents",value:function(t){var i=this,e=0<arguments.length&&void 0!==t?t:[];return!!this.components[e]||(e.reduce?e:[e]).reduce(function(t,e){return t&&!!i.components[e]},!0)}}]),o}();p.entities={},p.getByComps=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"array",i=t.reduce?t:[t];d.indexGroup(t,p.entities);var n=d.getGroup(i);return"map"===e?n.entities:n.array.concat()},p.reset=function(){s(p.entities,function(t){t.destroy()}),d.reset()},p.counter=0;function y(t,e){a()(this,y),this.draw=t,this.metaData=e}var v=window.Entity=p,f=function(){function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:10;a()(this,i),this.type=t,this.freePool=[],this.stats={free:0,used:0},this.incrementWhenEmpty=e}return h()(i,[{key:"reset",value:function(){this.freePool=[],this.stats={free:0,used:0}}},{key:"generate",value:function(t){for(var e=0<t-this.stats.free?t-this.stats.free:0;0<e;)this.freePool.push(new this.type),e--;this.stats.free=this.freePool.length}},{key:"acquire",value:function(){0===this.freePool.length&&this.generate(this.incrementWhenEmpty);var t=this.freePool.pop();return this.stats.free=this.freePool.length,t}},{key:"release",value:function(t){-1===this.freePool.indexOf(t)&&(this.freePool.push(t),this.stats.free=this.freePool.length)}}]),i}(),M=i(2),m=i.n(M);var g=function(){function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"white";if(a()(this,i),!t)throw"Cannot create layer, no initial context found";this.layers={initial:{ctx:t,shapes:new Map}},this.defaultStrokeStyle=e,t.strokeStyle=e}return h()(i,[{key:"addLayer",value:function(t){var e=this.layers.initial.ctx.canvas,i=e.parentNode,n=e.cloneNode();n.id=t,i.insertBefore(n,e),this.layers[t]={ctx:n.getContext("2d"),shapes:new Map}}},{key:"removeLayer",value:function(t){this.layers.initial.ctx.canvas.parentNode.querySelector("#".concat(t)).remove(),delete this.layers[t]}},{key:"clear",value:function(t){var e=0<arguments.length&&void 0!==t?t:"initial",i=this.layers[e];i.ctx;i.shapes=new Map}},{key:"clearAllLayers",value:function(){for(var t in this.layers)this.clear(t)}},{key:"remove",value:function(t,e){var i=1<arguments.length&&void 0!==e?e:"initial",n=this.layers[i];n.ctx;n.shapes.delete(t)}},{key:"addImage",value:function(t){var e=t.id,i=t.image,n=t.x,a=t.y,s=t.height,o=t.width,r=t.cropStartX,h=t.cropStartY,u=t.cropSizeX,l=t.cropSizeY,c=t.rotation,d=t.layerName,p=void 0===d?"initial":d,v=this.layers[p],f=v.ctx;v.shapes.set(e,new y(function(){f.beginPath(),f.save(),f.translate(n+o/2,a+s/2),f.rotate(c),f.drawImage(i,r,h,u,l,-o/2,-s/2,o,s),f.restore(),f.closePath()},{id:e,type:"image",x:n,y:a,height:s,width:o}))}},{key:"addShape",value:function(t){var e=t.id,i=t.drawFn,n=t.layerName,a=void 0===n?"initial":n,s=this.layers[a],o=s.ctx;s.shapes.set(e,new y(function(){i(o)}))}},{key:"writeBubble",value:function(t){var e=t.id,i=t.text,n=t.backgroundColor,a=t.borderColor,s=t.borderWidth,o=t.fontSize,r=t.fontColor,h=t.x,u=t.y,l=t.fontFace,c=t.height,d=t.width,p=t.paddingLeft,v=void 0===p?10:p,f=t.paddingTop,y=void 0===f?10:f,M=t.layerName,m=void 0===M?"initial":M,g=0,x=i.split("\n"),w=o||this.layers.initial.ctx.font.split("px")[0],k=l||this.layers.initial.ctx.font.split("px")[1];this.layers.initial.ctx.font="".concat(w,"px ").concat(k);for(var C=0;C<x.length;C++){var P=this.layers[m].ctx.measureText(x[C]).width;g=g<P?P:g}this.addRect({id:"".concat(e),x:h,y:u,height:Math.max(c,x.length*w+2*y),width:Math.max(d,g+2*v+s),fillColor:n,lineWidth:s,strokeStyle:a,layerName:m});for(var b=0;b<x.length;b++)this.write({id:"".concat(e,"-bubbleText-").concat(b),text:x[b],x:h+v,y:u+w+y+b*w,fillStyle:r,font:"".concat(w,"px ").concat(k),layerName:m})}},{key:"addRect",value:function(t){var e=t.id,i=t.x,n=t.y,a=t.width,s=t.height,o=t.strokeStyle,r=t.lineWidth,h=t.fillColor,u=t.layerName,l=void 0===u?"initial":u,c=this.layers[l],d=c.ctx;c.shapes.set(e,new y(function(){d.strokeStyle=o,d.lineWidth=r,d.beginPath(),d.rect(i,n,a,s),h&&(d.fillStyle=h,d.fill()),d.stroke(),d.closePath()},{id:e,type:"rect",x:i,y:n,height:s,width:a}))}},{key:"addArc",value:function(t){var e=t.id,i=t.direction,n=t.size,a=t.color,s=void 0===a?"black":a,o=t.fillColor,r=t.lineWidth,h=void 0===r?1:r,u=t.x,l=t.y,c=t.radius,d=t.layerName,p=void 0===d?"initial":d,v=this.layers[p],f=v.ctx;v.shapes.set(e,new y(function(){f.strokeStyle=s,f.lineWidth=h;var t=i-n/2,e=i+n/2;f.beginPath(),f.arc(u,l,c,t*Math.PI,e*Math.PI),o&&(f.fillStyle=o,f.fill()),f.stroke(),f.closePath()}))}},{key:"addCircle",value:function(t){var e=t.id,i=t.x,n=t.y,a=t.radius,s=t.lineWidth,o=t.fillColor,r=t.layerName,h=void 0===r?"initial":r,u=this.layers[h],l=u.ctx;u.shapes.set(e,new y(function(){l.lineWidth=s,l.moveTo(i,n),l.beginPath(),l.arc(i,n,a,0,2*Math.PI),o&&(l.fillStyle=o,l.fill()),l.stroke(),l.closePath()},{id:e,type:"circle",x:i,y:n,radius:a}))}},{key:"pan",value:function(t,e){for(var i in this.panX=t,this.panY=e,this.layers){this.layers[i].ctx.setTransform(1,0,0,1,t,e),"initial"!==i&&this.draw(i)}}},{key:"getPan",value:function(){return{panX:this.panX||0,panY:this.panY||0}}},{key:"write",value:function(t){var e=t.id,i=t.text,n=t.x,a=t.y,s=t.font,o=t.textBaseline,r=t.fillStyle,h=t.strokeStyle,u=t.layerName,l=void 0===u?"initial":u,c=this.layers[l],d=c.ctx;c.shapes.set(e,new y(function(){d.beginPath(),d.font=s,d.textBaseline=o,d.fillStyle=r,d.strokeStyle=h,d.fillText(i,n,a),d.closePath()},{id:e,x:n,y:a}))}},{key:"draw",value:function(t){var e=0<arguments.length&&void 0!==t?t:"initial",i=this.layers[e],n=i.ctx,a=i.shapes;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.restore();var s=!0,o=!1,r=void 0;try{for(var h,u=a.values()[Symbol.iterator]();!(s=(h=u.next()).done);s=!0){h.value.draw(),n.strokeStyle=this.defaultStrokeStyle}}catch(t){o=!0,r=t}finally{try{s||null==u.return||u.return()}finally{if(o)throw r}}}}]),i}(),x=function(){function t(){a()(this,t),this.reset()}return h()(t,[{key:"reset",value:function(){this.start={x:0,y:0},this.end={x:0,y:0}}},{key:"getData",value:function(){return{start:Object.assign({},this.start),end:Object.assign({},this.end),width:this.getWidth(),height:this.getHeight()}}},{key:"getHeight",value:function(){return this.end.y-this.start.y}},{key:"getWidth",value:function(){return this.end.x-this.start.x}},{key:"setStart",value:function(t,e){this.start.x=t,this.start.y=e}},{key:"setEnd",value:function(t,e){this.end.x=t,this.end.y=e}}]),t}();var w=function(t,e,i,n,a){return Math.pow(t-i,2)+Math.pow(e-n,2)<Math.pow(a,2)};var k=function(t,u,l){var c=[];return t.forEach(function(t,e){if("selectedBox"!==e){var i=t.metaData||{},n=i.x,a=i.y,s=i.radius,o=i.width,r=i.height,h=i.type;"circle"===h&&w(u,l,n,a,s)?c.push(e):"rect"!==h&&"image"!==h||n<=u&&u<=n+o&&a<=l&&l<=a+r&&c.push(e)}}),c};var C=function(t,e){var l=Math.min(e.start.x,e.end.x),c=Math.max(e.start.x,e.end.x),d=Math.min(e.start.y,e.end.y),p=Math.max(e.start.y,e.end.y),v=[];return t.forEach(function(t,e){if("selectedBox"!==e){var i=t.metaData||{},n=i.x,a=i.y,s=(i.radius,i.width),o=i.height,r=i.type;if("circle"===r){l<=n&&n<=c&&d<=a&&a<=p&&v.push(e)}else if("rect"===r||"image"===r){var h=n+s/2,u=a+o/2;l<=h&&h<=c&&d<=u&&u<=p&&v.push(e)}}}),v},P=function(){function i(t){a()(this,i);function e(){}this.selectedBoxColor=t.selectedBoxColor||"blue",this.mapHeight=t.mapHeight,this.mapWidth=t.mapWidth,this.viewHeight=t.viewHeight,this.viewWidth=t.viewWidth,this.onViewMapClick=t.onViewMapClick||e,this.onViewMapMove=t.onViewMapMove||e,this.onMiniMapClick=t.onMiniMapClick||e,this.onMiniMapMove=t.onMiniMapMove||e,this.enableSelectBox=t.enableSelectBox,this.lastClick=0,this.dbClick=!1,this.lastTap=0,this.lastClick=!1,this.selectedBox=new x,this.updateViewMapCursorPosition=this.updateViewMapCursorPosition.bind(this),this.updateMiniMapCursorPosition=this.updateMiniMapCursorPosition.bind(this),this.handleMapMouseUp=this.handleMapMouseUp.bind(this),this.handleMapMouseDown=this.handleMapMouseDown.bind(this),this.handleMiniMapClick=this.handleMiniMapClick.bind(this),this.handleMiniMapMove=this.handleMiniMapMove.bind(this),this.handleMapMouseMove=this.handleMapMouseMove.bind(this),this.handleMapMouseLeave=this.handleMapMouseLeave.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleMapTouchEnd=this.handleMapTouchEnd.bind(this),this.handleMiniMapTouchStart=this.handleMiniMapTouchStart.bind(this)}return h()(i,[{key:"updateCursorPosition",value:function(t,e,i){var n=e.getBoundingClientRect(),a=t.clientX-n.left,s=t.clientY-n.top;return{x:a=Math.max(0,Math.round(a*(e.width/n.width)))-i.getPan().panX,y:s=Math.max(0,Math.round(s*(e.height/n.height)))-i.getPan().panY}}},{key:"handleMapMouseMove",value:function(){if(this.isMouseDown){if(!1===this.enableSelectBox)return;this.selectedBox.setEnd(this.viewMapX,this.viewMapY);var t=this.selectedBox.getData();this.mapAPI.addRect({id:"selectedBox",x:t.start.x,y:t.start.y,width:t.width,height:t.height,strokeStyle:this.selectedBoxColor})}this.onViewMapMove({x:this.viewMapX,y:this.viewMapY,isMouseDown:this.isMouseDown,dbClick:this.dbClick,selectedBox:this.selectedBox.getData()})}},{key:"handleMapMouseLeave",value:function(){this.isMouseDown&&this.handleMapMouseUp()}},{key:"handleMapTouchEnd",value:function(){this.isMouseDown=!1;var t=this.selectedBox.getData(),e=[];if(t.end.x===t.start.x){var i=t.end.x,n=t.end.y;e=k(this.mapAPI.layers.initial.shapes,i,n)}else e=C(this.mapAPI.layers.initial.shapes,t);this.mapAPI.addRect({id:"selectedBox",x:0,y:0,width:0,height:0}),this.onViewMapClick({x:this.viewMapX,y:this.viewMapY,isMouseDown:this.isMouseDown,dbClick:this.dbTap||this.dbClick,selectedBox:t,hits:e}),this.selectedBox.reset()}},{key:"handleMapMouseUp",value:function(){this.lastTap||this.handleMapTouchEnd()}},{key:"updateViewMapCursorPosition",value:function(t){var e=this.updateCursorPosition(t,this.viewMapCanvas,this.mapAPI),i=e.x,n=e.y;this.viewMapX=i,this.viewMapY=n}},{key:"updateMiniMapCursorPosition",value:function(t){var e=this.updateCursorPosition(t,this.miniMapCanvas,this.miniMapAPI),i=e.x,n=e.y;this.miniMapX=i,this.miniMapY=n}},{key:"getNewCanvasPairs",value:function(t){var e=t.getMapRef,i=t.getMiniRef;return{map:this.generateMapCanvas(e),minimap:this.generateMiniMapCanvas(i)}}},{key:"handleMiniMapMove",value:function(t){this.onMiniMapMove(t)}},{key:"handleMiniMapClick",value:function(t){var e=this.miniMapX,i=this.miniMapY,n=Math.max(e-this.viewWidth/2,0),a=Math.max(i-this.viewHeight/2,0),s=this.mapWidth,o=this.mapHeight;n=n+this.viewWidth<s?n:s-this.viewWidth,a=a+this.viewHeight<o?a:o-this.viewHeight,this.mapAPI.pan(-n,-a),this.updateMiniMapSquare(),this.onMiniMapClick(t)}},{key:"updateMiniMapSquare",value:function(){this.miniMapAPI.addRect({id:"currentMap",x:-this.mapAPI.getPan().panX,y:-this.mapAPI.getPan().panY,width:this.viewWidth,height:this.viewHeight,strokeStyle:"green",lineWidth:20})}},{key:"handleMapMouseDown",value:function(){if(!this.lastTap){var t=(new Date).getTime();this.dbClick=t-this.lastClick<300,this.lastClick=t,this.isMouseDown=!0,this.setSelectBox()}}},{key:"setSelectBox",value:function(){!1!==this.enableSelectBox&&(this.selectedBox.setStart(this.viewMapX,this.viewMapY),this.selectedBox.setEnd(this.viewMapX,this.viewMapY))}},{key:"handleTouchStart",value:function(t){var e=this.updateCursorPosition(t.touches[0],this.viewMapCanvas,this.mapAPI),i=e.x,n=e.y,a=(new Date).getTime();this.dbTap=a-this.lastTap<300,this.lastTap=a,this.viewMapX=i,this.viewMapY=n,this.setSelectBox()}},{key:"handleMiniMapTouchStart",value:function(t){var e=this.updateCursorPosition(t.touches[0],this.miniMapCanvas,this.miniMapAPI),i=e.x,n=e.y;this.miniMapX=i,this.miniMapY=n,this.handleMiniMapClick()}},{key:"handleTouchMove",value:function(t){t.preventDefault();var e,i,n=this.updateCursorPosition(t.touches[0],this.viewMapCanvas,this.mapAPI),a=n.x,s=n.y,o=this.mapAPI.getPan(),r=o.panX,h=o.panY;e=r+(a-this.viewMapX),i=h+(s-this.viewMapY),e=Math.min(e,0),i=Math.min(i,0);var u=this.mapWidth,l=this.mapHeight;e=-e+this.viewWidth<u?e:this.viewWidth-u,i=-i+this.viewHeight<l?i:this.viewHeight-l,this.mapAPI.pan(e,i)}},{key:"generateMapCanvas",value:function(e){var i=this;return m.a.createElement("canvas",{className:"viewMap",ref:function(t){if(!t)return null;i.viewMapCanvas=t,document.removeEventListener("mousemove",i.updateViewMapCursorPosition),document.addEventListener("mousemove",i.updateViewMapCursorPosition),t.removeEventListener("touchmove",i.handleTouchMove,!1),t.addEventListener("touchmove",i.handleTouchMove,!1),i.mapAPI=new g(t.getContext("2d")),e(i.mapAPI,t)},height:this.viewHeight,width:this.viewWidth,onMouseDown:this.handleMapMouseDown,onTouchStart:this.handleTouchStart,onTouchEnd:this.handleMapTouchEnd,onMouseMove:this.handleMapMouseMove,onMouseUp:this.handleMapMouseUp,onMouseLeave:this.handleMapMouseLeave})}},{key:"generateMiniMapCanvas",value:function(i){var n=this;return m.a.createElement("canvas",{className:"minimap",ref:function(t){if(!t)return null;n.miniMapCanvas=t,document.removeEventListener("mousemove",n.updateMiniMapCursorPosition),document.addEventListener("mousemove",n.updateMiniMapCursorPosition),n.miniMapAPI=new g(t.getContext("2d"));var e=setInterval(function(){n.mapAPI&&(n.updateMiniMapSquare(),clearInterval(e))},100);i(n.miniMapAPI,t)},height:this.mapHeight,width:this.mapWidth,onMouseMove:this.handleMiniMapMove,onMouseDown:this.handleMiniMapClick,onTouchStart:this.handleMiniMapTouchStart})}}]),i}(),b=function(){function t(){a()(this,t),this.systems=[],this.frameID=null}return h()(t,[{key:"addSystem",value:function(t){this.systems.push(t)}},{key:"run",value:function(e){var i=this;return this.frameID=requestAnimationFrame(function(){var t="function"==typeof e?e():e;i.runSystems(t),i.run(e)}),this.frameID}},{key:"runSystems",value:function(t){for(var e=0;e<this.systems.length;e++)this.systems[e](t)}},{key:"stop",value:function(){return cancelAnimationFrame(this.frameID),this.frameID}}]),t}();e.default={Entity:v,entityLoop:s,ObjectPool:f,GameCanvas:P,Engine:b}}],a.c=s,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(i,n,function(t){return e[t]}.bind(null,n));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="/",a(a.s=7);function a(t){if(s[t])return s[t].exports;var e=s[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,a),e.l=!0,e.exports}var n,s});
//# sourceMappingURL=index.js.map