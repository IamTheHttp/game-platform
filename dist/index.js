!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("react"));else if("function"==typeof define&&define.amd)define(["react"],t);else{var i="object"==typeof exports?t(require("react")):t(e.react);for(var n in i)("object"==typeof exports?exports:e)[n]=i[n]}}(window,function(i){return s={},a.m=n=[function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t,i){var n=i(4),a=i(5),s=i(6);e.exports=function(e){return n(e)||a(e)||s()}},function(e,t){e.exports=i},function(e,t){e.exports=function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}},function(e,t){e.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(e,t,i){"use strict";i.r(t);function s(t,i){var n=[];return t.forEach?t.forEach(function(e){i(e)&&n.push(e)}):Object.keys(t).forEach(function(e){i(t[e])&&n.push(t[e])}),n}function o(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};a()(this,o),this.components=e,this.entities=t,this.array=[]}var n=i(0),a=i.n(n),r=i(1),h=i.n(r),u=i(2),l=i.n(u);o.groups={},o.reset=function(){o.groups={}},o.generateGroupKey=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];t.push(n)}return t.map(function(e){return e.toLowerCase()}).sort().join("-")},o.getGroup=function(e){var t=o.generateGroupKey(e);return o.groups[t]||{}},o.indexGroup=function(e,t){var i,n=e.reduce?e:[e],a=o.generateGroupKey(n);if(!o.groups[a])return i=o.groups[a]=new o(n),s(t,function(e){e.hasComponents(n)&&(i.entities[e.id]=e,i.array=[].concat(l()(i.array),[e]))}),i};function c(e,t){var i=1<arguments.length&&void 0!==t?t:0,n=e.length;if(n&&!(n<=i)){for(;i<n;)e[i]=e[i+1],i++;e.length--}}var d=o,p=function(){function o(e){a()(this,o),o.counter++,this.id=o.counter,this.constructor=e,this.components={},o.entities[this.id]=this}return h()(o,[{key:"assignGroup",value:function(e){e.entities[this.id]=this}},{key:"addComponent",value:function(e){this.components[e.name]=e,this[e.name]=e;var t=[];for(var i in this.components)t.push(i);for(var n in d.indexGroup(t,o.entities),d.groups){var a=d.groups[n];if(!a.entities[this.id]&&(-1!==a.components.indexOf(e.name)&&this.hasComponents(a.components))){this.assignGroup(a);var s=this.copyArray(a);a.array=this.extendGroup(s)}}}},{key:"copyArray",value:function(e){return e.array}},{key:"extendGroup",value:function(e){return e[e.length]=this,e}},{key:"removeComponent",value:function(e){var t=this.components[e]||e,i=t.name;for(var n in d.groups){var a=d.groups[n],s=-1<a.components.indexOf(t.name),o=this.hasComponents(a.components);a.entities[this.id]&&s&&o&&(delete a.entities[this.id],c(a.array,a.array.indexOf(this)))}delete this.components[i],delete this[i]}},{key:"destroy",value:function(){var t=this;Object.keys(this.components).forEach(function(e){t.removeComponent(t.components[e])}),delete o.entities[this.id]}},{key:"hasComponents",value:function(e){var i=this,t=0<arguments.length&&void 0!==e?e:[];return!!this.components[t]||(t.reduce?t:[t]).reduce(function(e,t){return e&&!!i.components[t]},!0)}}]),o}();p.entities={},p.getByComps=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"array",i=e.reduce?e:[e];d.indexGroup(e,p.entities);var n=d.getGroup(i);return"map"===t?n.entities:n.array.concat()},p.reset=function(){s(p.entities,function(e){e.destroy()}),d.reset()},p.counter=0;function y(e,t){a()(this,y),this.draw=e,this.metaData=t}var v=window.Entity=p,f=function(){function i(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:10;a()(this,i),this.type=e,this.freePool=[],this.stats={free:0,used:0},this.incrementWhenEmpty=t}return h()(i,[{key:"reset",value:function(){this.freePool=[],this.stats={free:0,used:0}}},{key:"generate",value:function(e){for(var t=0<e-this.stats.free?e-this.stats.free:0;0<t;)this.freePool.push(new this.type),t--;this.stats.free=this.freePool.length}},{key:"acquire",value:function(){0===this.freePool.length&&this.generate(this.incrementWhenEmpty);var e=this.freePool.pop();return this.stats.free=this.freePool.length,e}},{key:"release",value:function(e){-1===this.freePool.indexOf(e)&&(this.freePool.push(e),this.stats.free=this.freePool.length)}}]),i}(),M=i(3),m=i.n(M);var g=function(){function i(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"white";if(a()(this,i),!e)throw"Cannot create layer, no initial context found";this.layers={initial:{ctx:e,shapes:new Map}},this.defaultStrokeStyle=t,e.strokeStyle=t}return h()(i,[{key:"addLayer",value:function(e){var t=this.layers.initial.ctx.canvas,i=t.parentNode,n=t.cloneNode();n.id=e,i.insertBefore(n,t),this.layers[e]={ctx:n.getContext("2d"),shapes:new Map}}},{key:"removeLayer",value:function(e){this.layers.initial.ctx.canvas.parentNode.querySelector("#".concat(e)).remove(),delete this.layers[e]}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e?e:"initial",i=this.layers[t];i.ctx;i.shapes=new Map}},{key:"clearAllLayers",value:function(){for(var e in this.layers)this.clear(e)}},{key:"remove",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:"initial",n=this.layers[i];n.ctx;n.shapes.delete(e)}},{key:"addImage",value:function(e){var t=e.id,i=e.image,n=e.x,a=e.y,s=e.height,o=e.width,r=e.cropStartX,h=e.cropStartY,u=e.cropSizeX,l=e.cropSizeY,c=e.rotation,d=e.layerName,p=void 0===d?"initial":d,v=this.layers[p],f=v.ctx;v.shapes.set(t,new y(function(){f.beginPath(),f.save(),f.translate(n+o/2,a+s/2),f.rotate(c),f.drawImage(i,r,h,u,l,-o/2,-s/2,o,s),f.restore(),f.closePath()},{id:t,type:"image",x:n,y:a,height:s,width:o}))}},{key:"addShape",value:function(e){var t=e.id,i=e.drawFn,n=e.layerName,a=void 0===n?"initial":n,s=this.layers[a],o=s.ctx;s.shapes.set(t,new y(function(){i(o)}))}},{key:"writeBubble",value:function(e){var t=e.id,i=e.text,n=e.backgroundColor,a=e.borderColor,s=e.borderWidth,o=e.fontSize,r=e.fontColor,h=e.x,u=e.y,l=e.fontFace,c=e.height,d=e.width,p=e.paddingLeft,v=void 0===p?10:p,f=e.paddingTop,y=void 0===f?10:f,M=e.layerName,m=void 0===M?"initial":M,g=0,x=i.split("\n"),w=o||this.layers.initial.ctx.font.split("px")[0],k=l||this.layers.initial.ctx.font.split("px")[1];this.layers.initial.ctx.font="".concat(w,"px ").concat(k);for(var C=0;C<x.length;C++){var P=this.layers[m].ctx.measureText(x[C]).width;g=g<P?P:g}this.addRect({id:"".concat(t),x:h,y:u,height:Math.max(c,x.length*w+2*y),width:Math.max(d,g+2*v+s),fillColor:n,lineWidth:s,strokeStyle:a,layerName:m});for(var b=0;b<x.length;b++)this.write({id:"".concat(t,"-bubbleText-").concat(b),text:x[b],x:h+v,y:u+w+y+b*w,fillStyle:r,font:"".concat(w,"px ").concat(k),layerName:m})}},{key:"addRect",value:function(e){var t=e.id,i=e.x,n=e.y,a=e.width,s=e.height,o=e.strokeStyle,r=e.lineWidth,h=e.fillColor,u=e.layerName,l=void 0===u?"initial":u,c=this.layers[l];if(!c)throw"Could not find layer '".concat(l,"', are you sure you created the layer?");var d=c.ctx;c.shapes.set(t,new y(function(){d.strokeStyle=o,d.lineWidth=r,d.beginPath(),d.rect(i,n,a,s),h&&(d.fillStyle=h,d.fill()),d.stroke(),d.closePath()},{id:t,type:"rect",x:i,y:n,height:s,width:a}))}},{key:"addArc",value:function(e){var t=e.id,i=e.direction,n=e.size,a=e.color,s=void 0===a?"black":a,o=e.fillColor,r=e.lineWidth,h=void 0===r?1:r,u=e.x,l=e.y,c=e.radius,d=e.layerName,p=void 0===d?"initial":d,v=this.layers[p],f=v.ctx;v.shapes.set(t,new y(function(){f.strokeStyle=s,f.lineWidth=h;var e=i-n/2,t=i+n/2;f.beginPath(),f.arc(u,l,c,e*Math.PI,t*Math.PI),o&&(f.fillStyle=o,f.fill()),f.stroke(),f.closePath()}))}},{key:"addCircle",value:function(e){var t=e.id,i=e.x,n=e.y,a=e.radius,s=e.lineWidth,o=e.color,r=e.fillColor,h=e.layerName,u=void 0===h?"initial":h,l=this.layers[u],c=l.ctx;l.shapes.set(t,new y(function(){c.strokeStyle=o,c.lineWidth=s,c.moveTo(i,n),c.beginPath(),c.arc(i,n,a,0,2*Math.PI),r&&(c.fillStyle=r,c.fill()),c.stroke(),c.closePath()},{id:t,type:"circle",x:i,y:n,radius:a}))}},{key:"pan",value:function(e,t){for(var i in this.panX=e,this.panY=t,this.layers){this.layers[i].ctx.setTransform(1,0,0,1,e,t),"initial"!==i&&this.draw(i)}}},{key:"getPan",value:function(){return{panX:this.panX||0,panY:this.panY||0}}},{key:"write",value:function(e){var t=e.id,i=e.text,n=e.x,a=e.y,s=e.font,o=e.textBaseline,r=e.fillStyle,h=e.strokeStyle,u=e.layerName,l=void 0===u?"initial":u,c=this.layers[l],d=c.ctx;c.shapes.set(t,new y(function(){d.beginPath(),d.font=s,d.textBaseline=o,d.fillStyle=r,d.strokeStyle=h,d.fillText(i,n,a),d.closePath()},{id:t,x:n,y:a}))}},{key:"draw",value:function(e){var t=0<arguments.length&&void 0!==e?e:"initial",i=this.layers[t],n=i.ctx,a=i.shapes;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.restore();var s=!0,o=!1,r=void 0;try{for(var h,u=a.values()[Symbol.iterator]();!(s=(h=u.next()).done);s=!0){h.value.draw(),n.strokeStyle=this.defaultStrokeStyle}}catch(e){o=!0,r=e}finally{try{s||null==u.return||u.return()}finally{if(o)throw r}}}}]),i}(),x=function(){function e(){a()(this,e),this.reset()}return h()(e,[{key:"reset",value:function(){this.start={x:0,y:0},this.end={x:0,y:0}}},{key:"getData",value:function(){return{start:Object.assign({},this.start),end:Object.assign({},this.end),width:this.getWidth(),height:this.getHeight()}}},{key:"getHeight",value:function(){return this.end.y-this.start.y}},{key:"getWidth",value:function(){return this.end.x-this.start.x}},{key:"setStart",value:function(e,t){this.start.x=e,this.start.y=t}},{key:"setEnd",value:function(e,t){this.end.x=e,this.end.y=t}}]),e}();var w=function(e,t,i,n,a){return Math.pow(e-i,2)+Math.pow(t-n,2)<Math.pow(a,2)};var k=function(e,u,l,c){var d=[];return e.forEach(function(e,t){if("selectedBox"!==t){var i=e.metaData||{},n=i.x,a=i.y,s=i.radius,o=i.width,r=i.height,h=i.type;"circle"===h&&w(l,c,n,a,s)?d.push({id:t,layerName:u}):"rect"!==h&&"image"!==h||n<=l&&l<=n+o&&a<=c&&c<=a+r&&d.push({id:t,layerName:u})}}),d};var C=function(e,l,t){var c=Math.min(t.start.x,t.end.x),d=Math.max(t.start.x,t.end.x),p=Math.min(t.start.y,t.end.y),v=Math.max(t.start.y,t.end.y),f=[];return e.forEach(function(e,t){if("selectedBox"!==t){var i=e.metaData||{},n=i.x,a=i.y,s=(i.radius,i.width),o=i.height,r=i.type;if("circle"===r){c<=n&&n<=d&&p<=a&&a<=v&&f.push({id:t,layerName:l})}else if("rect"===r||"image"===r){var h=n+s/2,u=a+o/2;c<=h&&h<=d&&p<=u&&u<=v&&f.push({id:t,layerName:l})}}}),f},P=function(){function i(e){a()(this,i);function t(){}this.selectedBoxColor=e.selectedBoxColor||"blue",this.mapHeight=e.mapHeight,this.mapWidth=e.mapWidth,this.viewHeight=e.viewHeight,this.viewWidth=e.viewWidth,this.onViewMapClick=e.onViewMapClick||t,this.onViewMapMove=e.onViewMapMove||t,this.onMiniMapClick=e.onMiniMapClick||t,this.onMiniMapMove=e.onMiniMapMove||t,this.enableSelectBox=e.enableSelectBox,this.lastClick=0,this.dbClick=!1,this.lastTap=0,this.lastClick=!1,this.selectedBox=new x,this.updateViewMapCursorPosition=this.updateViewMapCursorPosition.bind(this),this.updateMiniMapCursorPosition=this.updateMiniMapCursorPosition.bind(this),this.handleMapMouseUp=this.handleMapMouseUp.bind(this),this.handleMapMouseDown=this.handleMapMouseDown.bind(this),this.handleMiniMapClick=this.handleMiniMapClick.bind(this),this.handleMiniMapMove=this.handleMiniMapMove.bind(this),this.handleMapMouseMove=this.handleMapMouseMove.bind(this),this.handleMapMouseLeave=this.handleMapMouseLeave.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleMapTouchEnd=this.handleMapTouchEnd.bind(this),this.handleMiniMapTouchStart=this.handleMiniMapTouchStart.bind(this)}return h()(i,[{key:"updateCursorPosition",value:function(e,t,i){var n=t.getBoundingClientRect(),a=e.clientX-n.left,s=e.clientY-n.top;return{x:a=Math.max(0,Math.round(a*(t.width/n.width)))-i.getPan().panX,y:s=Math.max(0,Math.round(s*(t.height/n.height)))-i.getPan().panY}}},{key:"handleMapMouseMove",value:function(){if(this.isMouseDown){if(!1===this.enableSelectBox)return;this.selectedBox.setEnd(this.viewMapX,this.viewMapY);var e=this.selectedBox.getData();this.mapAPI.addRect({id:"selectedBox",x:e.start.x,y:e.start.y,width:e.width,height:e.height,strokeStyle:this.selectedBoxColor})}this.onViewMapMove({x:this.viewMapX,y:this.viewMapY,isMouseDown:this.isMouseDown,dbClick:this.dbClick,selectedBox:this.selectedBox.getData()})}},{key:"handleMapMouseLeave",value:function(){this.isMouseDown&&this.handleMapMouseUp()}},{key:"handleMapTouchEnd",value:function(){var n=this;this.isMouseDown=!1;var a=this.selectedBox.getData(),e=Object.keys(this.mapAPI.layers),s=[];e.forEach(function(e){if(a.end.x===a.start.x){var t=n.viewMapX,i=n.viewMapY;s=[].concat(l()(s),l()(k(n.mapAPI.layers[e].shapes,e,t,i)))}else s=[].concat(l()(s),l()(C(n.mapAPI.layers[e].shapes,e,a)))}),this.mapAPI.addRect({id:"selectedBox",x:0,y:0,width:0,height:0}),this.onViewMapClick({x:this.viewMapX,y:this.viewMapY,isMouseDown:this.isMouseDown,dbClick:this.dbTap||this.dbClick,selectedBox:a,hits:s}),this.selectedBox.reset()}},{key:"handleMapMouseUp",value:function(){this.lastTap||this.handleMapTouchEnd()}},{key:"updateViewMapCursorPosition",value:function(e){var t=this.updateCursorPosition(e,this.viewMapCanvas,this.mapAPI),i=t.x,n=t.y;this.viewMapX=i,this.viewMapY=n}},{key:"updateMiniMapCursorPosition",value:function(e){var t=this.updateCursorPosition(e,this.miniMapCanvas,this.miniMapAPI),i=t.x,n=t.y;this.miniMapX=i,this.miniMapY=n}},{key:"getNewCanvasPairs",value:function(e){var t=e.getMapRef,i=e.getMiniRef;return{map:this.generateMapCanvas(t),minimap:this.generateMiniMapCanvas(i)}}},{key:"handleMiniMapMove",value:function(e){this.onMiniMapMove(e)}},{key:"handleMiniMapClick",value:function(e){var t=this.miniMapX,i=this.miniMapY,n=Math.max(t-this.viewWidth/2,0),a=Math.max(i-this.viewHeight/2,0),s=this.mapWidth,o=this.mapHeight;n=n+this.viewWidth<s?n:s-this.viewWidth,a=a+this.viewHeight<o?a:o-this.viewHeight,this.mapAPI.pan(-n,-a),this.updateMiniMapSquare(),this.onMiniMapClick(e)}},{key:"updateMiniMapSquare",value:function(){this.miniMapAPI.addRect({id:"currentMap",x:-this.mapAPI.getPan().panX,y:-this.mapAPI.getPan().panY,width:this.viewWidth,height:this.viewHeight,strokeStyle:"green",lineWidth:20})}},{key:"handleMapMouseDown",value:function(){if(!this.lastTap){var e=(new Date).getTime();this.dbClick=e-this.lastClick<300,this.lastClick=e,this.isMouseDown=!0,this.setSelectBox()}}},{key:"setSelectBox",value:function(){!1!==this.enableSelectBox&&(this.selectedBox.setStart(this.viewMapX,this.viewMapY),this.selectedBox.setEnd(this.viewMapX,this.viewMapY))}},{key:"handleTouchStart",value:function(e){var t=this.updateCursorPosition(e.touches[0],this.viewMapCanvas,this.mapAPI),i=t.x,n=t.y,a=(new Date).getTime();this.dbTap=a-this.lastTap<300,this.lastTap=a,this.viewMapX=i,this.viewMapY=n,this.setSelectBox()}},{key:"handleMiniMapTouchStart",value:function(e){var t=this.updateCursorPosition(e.touches[0],this.miniMapCanvas,this.miniMapAPI),i=t.x,n=t.y;this.miniMapX=i,this.miniMapY=n,this.handleMiniMapClick()}},{key:"handleTouchMove",value:function(e){e.preventDefault();var t,i,n=this.updateCursorPosition(e.touches[0],this.viewMapCanvas,this.mapAPI),a=n.x,s=n.y,o=this.mapAPI.getPan(),r=o.panX,h=o.panY;t=r+(a-this.viewMapX),i=h+(s-this.viewMapY),t=Math.min(t,0),i=Math.min(i,0);var u=this.mapWidth,l=this.mapHeight;t=-t+this.viewWidth<u?t:this.viewWidth-u,i=-i+this.viewHeight<l?i:this.viewHeight-l,this.mapAPI.pan(t,i)}},{key:"generateMapCanvas",value:function(t){var i=this;return m.a.createElement("canvas",{className:"viewMap",ref:function(e){if(!e)return null;i.viewMapCanvas=e,document.removeEventListener("mousemove",i.updateViewMapCursorPosition),document.addEventListener("mousemove",i.updateViewMapCursorPosition),e.removeEventListener("touchmove",i.handleTouchMove,!1),e.addEventListener("touchmove",i.handleTouchMove,!1),i.mapAPI=new g(e.getContext("2d")),t(i.mapAPI,e)},height:this.viewHeight,width:this.viewWidth,onMouseDown:this.handleMapMouseDown,onTouchStart:this.handleTouchStart,onTouchEnd:this.handleMapTouchEnd,onMouseMove:this.handleMapMouseMove,onMouseUp:this.handleMapMouseUp,onMouseLeave:this.handleMapMouseLeave})}},{key:"generateMiniMapCanvas",value:function(i){var n=this;return m.a.createElement("canvas",{className:"minimap",ref:function(e){if(!e)return null;n.miniMapCanvas=e,document.removeEventListener("mousemove",n.updateMiniMapCursorPosition),document.addEventListener("mousemove",n.updateMiniMapCursorPosition),n.miniMapAPI=new g(e.getContext("2d"));var t=setInterval(function(){n.mapAPI&&(n.updateMiniMapSquare(),clearInterval(t))},100);i(n.miniMapAPI,e)},height:this.mapHeight,width:this.mapWidth,onMouseMove:this.handleMiniMapMove,onMouseDown:this.handleMiniMapClick,onTouchStart:this.handleMiniMapTouchStart})}}]),i}(),b=function(){function e(){a()(this,e),this.systems=[],this.frameID=null}return h()(e,[{key:"addSystem",value:function(e){this.systems.push(e)}},{key:"run",value:function(t){var i=this;return this.frameID=requestAnimationFrame(function(){i.run(t);var e="function"==typeof t?t():t;i.runSystems(e)}),this.frameID}},{key:"runSystems",value:function(e){for(var t=0;t<this.systems.length;t++)this.systems[t](e)}},{key:"stop",value:function(){return cancelAnimationFrame(this.frameID),this.frameID}}]),e}();t.default={Entity:v,entityLoop:s,ObjectPool:f,GameCanvas:P,Engine:b}}],a.c=s,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(i,n,function(e){return t[e]}.bind(null,n));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=7);function a(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,a),t.l=!0,t.exports}var n,s});
//# sourceMappingURL=index.js.map